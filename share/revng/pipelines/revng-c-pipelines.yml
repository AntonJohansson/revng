#
# Copyright (c) rev.ng Labs Srl. See LICENSE.md for details.
#

Component: revng-c
Containers:
  - Name: types-and-globals.h
    Type: ModelHeader
  - Name: helpers.h
    Type: HelpersHeader
  - Name: decompiled.c
    Type: DecompiledCCode
  - Name: decompiled.tar.gz
    Type: DecompiledCCodeInYAML
  - Name: module.mlir
    Type: MLIRModule
  - Name: type-targets.yml
    Type: TypeKindTargetContainer
  - Name: model-type-definitions.tar.gz
    Type: ModelTypeDefinitions
Branches:
  - From: enforce-abi
    Steps:
      - Name: remove-lifting-artifacts
        Pipes:
          - Type: LLVMPipe
            UsedContainers: [module.ll]
            Passes:
              - dce
              - remove-lifting-artifacts
              - promote-init-csv-to-undef
      - Name: promote-stack-pointer
        Pipes:
          - Type: LLVMPipe
            UsedContainers: [module.ll]
            Passes:
              - measure-stack-size-at-call-sites
              - promote-stack-pointer
      - Name: early-optimize
        Pipes:
          - Type: LLVMPipe
            UsedContainers: [module.ll]
            Passes:
              - dce
              - remove-extractvalues
              - simplify-cfg-with-hoist-and-sink
              - dse
              - instcombine
              - remove-extractvalues
              - sroa
              - instsimplify
              - jump-threading
              - licm
              - unreachableblockelim
              - instcombine
              - remove-extractvalues
              - early-cse
              - simplify-cfg-with-hoist-and-sink
              - type-shrinking
              - early-cse
              - instsimplify
              - gvn
              - instsimplify
              - dse
              - dce
      - Name: detect-stack-size
        Pipes:
          - Type: LLVMPipe
            UsedContainers: [module.ll]
            Passes:
              - remove-stack-alignment
              - instrument-stack-accesses
              - instcombine
              - remove-extractvalues
              - compute-stack-accesses-bounds
        Analyses:
          - Name: detect-stack-size
            Type: detect-stack-size
            UsedContainers: [module.ll]
      - Name: segregate-stack-accesses
        Pipes:
          - Type: LLVMPipe
            UsedContainers: [module.ll]
            Passes:
              - hoist-struct-phis
              - segregate-stack-accesses
      - Name: late-optimize
        Pipes:
          - Type: LLVMPipe
            UsedContainers: [module.ll]
            Passes:
              - cleanup-stack-size-markers
              - dce
              - sroa
              - instcombine
              - remove-extractvalues
              - sroa
              - simplify-cfg-with-hoist-and-sink
              - loop-rewrite-with-canonical-induction-variable
              - simplify-cfg-with-hoist-and-sink
              # don't run simplify-cfg{,-with-hoist-and-sink} after
              # loop-simplify because it kills the loop-simplify form causing
              # DLA not to identify arrays properly
              - loop-simplify
              - instcombine
              - remove-extractvalues
              - early-cse
              - dce
              - strip-dead-prototypes
              - split-overflow-intrinsics
              - dce
      - Name: make-segment-refs
        Pipes:
          - Type: MakeSegmentRefs
            UsedContainers: [input, module.ll]
        Artifacts:
          Container: module.ll
          Kind: StackAccessesSegregated
          SingleTargetFilename: stack_access_segregate.ll
        Analyses:
          - Name: analyze-data-layout
            Type: analyze-data-layout
            UsedContainers: [module.ll]
          - Name: convert-to-cabi
            Type: ConvertToCABIFunctionType
            UsedContainers: []
      - Name: canonicalize
        Pipes:
          - Type: LLVMPipe
            UsedContainers: [module.ll]
            Passes:
              - hoist-struct-phis
              - remove-llvmassume-calls
              - dce
              - remove-pointer-casts
              - make-model-gep
              - dce
              - exit-ssa
              - twoscomplement-normalization
              - ternary-reduction
              - make-local-variables
              - remove-load-store
              - fold-model-gep
              - dce
              - add-assignment-markers
              - make-model-cast
              - operatorprecedence-resolution
              - pretty-int-formatting
      - Name: decompile
        Pipes:
          - Type: HelpersToHeader
            UsedContainers: [module.ll, helpers.h]
          - Type: ModelToHeader
            UsedContainers: [input, types-and-globals.h]
          - Type: CDecompilation
            UsedContainers: [module.ll, decompiled.tar.gz]
        Artifacts:
          Container: decompiled.tar.gz
          Kind: DecompiledToYAML
          SingleTargetFilename: decompiled.c
        Analyses:
          - Name: import-from-c
            Type: ImportModelFromC
            UsedContainers: []
      - Name: decompile-to-single-file
        Pipes:
          - Type: DecompiledYAMLToC
            UsedContainers: [decompiled.tar.gz, decompiled.c]
        Artifacts:
          Container: decompiled.c
          Kind: DecompiledToC
          SingleTargetFilename: binary_decompiled.c
  - From: canonicalize
    Steps:
      - Name: emit-helpers-header
        Pipes:
          - Type: HelpersToHeader
            UsedContainers: [module.ll, helpers.h]
        Artifacts:
          Container: helpers.h
          Kind: HelpersHeader
          SingleTargetFilename: helpers.h
  - From: initial
    Steps:
      - Name: emit-model-header
        Pipes:
          - Type: ModelToHeader
            UsedContainers: [input, types-and-globals.h]
        Artifacts:
          Container: types-and-globals.h
          Kind: ModelHeader
          SingleTargetFilename: types-and-globals.h
  - From: canonicalize
    Steps:
      - Name: emit-type-definitions
        Pipes:
          - Type: PopulateTypeKindTargetContainer
            UsedContainers: [input, type-targets.yml]
          - Type: GenerateModelTypeDefinition
            UsedContainers: [type-targets.yml, model-type-definitions.tar.gz]
        Artifacts:
          Container: model-type-definitions.tar.gz
          Kind: ModelTypeDefinition
          SingleTargetFilename: type.h
  - From: make-segment-refs
    Steps:
      - Name: convert-to-mlir
        Pipes:
          - Type: LLVMPipe
            UsedContainers: [module.ll]
            Passes:
              - prepare-llvmir-for-mlir
          - Type: ImportLLVMToMLIRPipe
            UsedContainers: [module.ll, module.mlir]
        Artifacts:
          Container: module.mlir
          Kind: MLIRLLVMModule
          SingleTargetFilename: mlir-llvm-dialect.mlir
AnalysesLists:
  - Name: revng-c-initial-auto-analysis
    Analyses:
      - detect-stack-size
      - analyze-data-layout
      - convert-functions-to-cabi
