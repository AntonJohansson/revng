#
# Copyright (c) rev.ng Labs Srl. See LICENSE.md for details.
#

tags:
  - name: header-to-model
sources:
  - tags: [header-to-model]
    prefix: share/revng/test/tests/analysis/ImportFromCAnalysis/
    members:
      - struct.model.yml
      - union.model.yml
      - cabifunctiontype.model.yml
      - cabifunctiontype-with-complex-args.model.yml
      - enumtype.model.yml
      - typedef.model.yml
      - primitive-types.model.yml
      - rft-multiple-regs-for-return-val.model.yml
      - rft-single-reg-for-return-val.model.yml
commands:
  - type: revng-c.header-to-model
    from:
      - type: source
        filter: header-to-model
    command: |-
      RESUME=$$(temp -d);
      mkdir -p "$$RESUME/context/";
      cp "$INPUT" "$$RESUME/context/model.yml";
      revng analyze --resume "$$RESUME" import-from-c
      --import-from-c-location-to-edit="$$(grep -vE '^(#|$$)' ${SOURCE}.location)"
      --import-from-c-ccode="$$(cat ${SOURCE}.ccode)" /dev/null -o /dev/null;
      revng model compare "${SOURCE}.reference.yml"
      "$$RESUME/context/model.yml";
