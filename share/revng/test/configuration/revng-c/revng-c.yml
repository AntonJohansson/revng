#
# Copyright (c) rev.ng Labs Srl. See LICENSE.md for details.
#

commands:
  - type: revng-c.lifting-artifacts-removed
    from:
      - type: revng.abi-enforced-for-decompilation
    suffix: .bc
    command: |-
      revng llvm pipeline
        "$INPUT"
        "$OUTPUT"
        EnforceABI
        RemoveLiftingArtifacts
        "*:LiftingArtifactsRemoved"
  - type: revng-c.stack-pointer-promoted
    from:
      - type: revng-c.lifting-artifacts-removed
    suffix: .bc
    command: |-
      revng llvm pipeline
        "$INPUT"
        "$OUTPUT"
        RemoveLiftingArtifacts
        PromoteStackPointer
        "*:StackPointerPromoted"
  - type: revng-c.analyzed
    from:
      - type: revng-c.stack-pointer-promoted
      - type: revng-qa.compiled
        filter: one-per-architecture
    suffix: .bc
    command: |-
      revng llvm pipeline
        "$INPUT1"
        "$OUTPUT"
        PromoteStackPointer
        DetectStackSize
        "*:StackPointerPromoted"
        --analysis detect-stack-size;
      revng llvm pipeline
        --binary "$INPUT2"
        "$OUTPUT"
        "$OUTPUT"
        DetectStackSize
        MakeSegmentRefs
        "*:StackAccessesSegregated"
        --analysis dla
  - type: revng-c.vma
    from:
      - type: revng-c.analyzed
    command: revng opt -vma -vma-mincut-iter=50 "$INPUT" -o /dev/null
  - type: revng-c.canonicalized
    from:
      - type: revng-c.analyzed
      - type: revng-qa.compiled
        filter: one-per-architecture
    suffix: .bc
    command: |-
      revng llvm pipeline
        --binary "$INPUT2"
        "$INPUT1"
        "$OUTPUT"
        MakeSegmentRefs
        IRCanonicalization
        "*:StackAccessesSegregated"
  - type: revng-c.ptml-model-to-header
    from:
      - type: revng-c.analyzed
    suffix: .ptml.model.h
    command: |-
      revng model to-header -i "$INPUT" -o "$OUTPUT";
  - type: revng-c.model-to-header
    from:
      - type: revng-c.ptml-model-to-header
    suffix: .model.h
    command: |-
      revng ptml --plain "$INPUT" -o "$OUTPUT";
      revng check-decompiled-c "$OUTPUT";
  - type: revng-c.ptml-helpers-to-header
    from:
      - type: revng-c.canonicalized
    suffix: .ptml.helpers.h
    command: |-
      revng helpers-to-header -i "$INPUT" -o "$OUTPUT";
  - type: revng-c.helpers-to-header
    from:
      - type: revng-c.ptml-helpers-to-header
    suffix: .helpers.h
    command: |-
      revng ptml --plain "$INPUT" -o "$OUTPUT"
      revng check-decompiled-c "$OUTPUT"
  - type: revng-c.ptml-decompiled-c
    from:
      - type: revng-c.canonicalized
    suffix: .ptml.c
    command: |-
      MODEL=$$(temp);
      revng model dump "$INPUT" > "$$MODEL";
      revng pipeline
        -m "$$MODEL"
        -i "$INPUT:IRCanonicalization/module.ll"
        -o "$OUTPUT:DecompiledYAMLToC/decompiled.c"
        --produce DecompiledYAMLToC/decompiled.c/:DecompiledToC
  - type: revng-c.decompiled-c
    from:
      - type: revng-c.ptml-decompiled-c
    suffix: .c
    command: |-
      revng ptml --plain "$INPUT" -o "$OUTPUT"
  - type: revng-c.check-decompiled-c-arch-i386
    from:
      - type: revng-c.decompiled-c
        filter: one-per-architecture and i386
      - type: revng-c.model-to-header
        filter: one-per-architecture and i386
      - type: revng-c.helpers-to-header
        filter: one-per-architecture and i386
    command: |-
      TMP=$$(temp -d);
      cp -a "$INPUT1" "$$TMP/decompiled.c";
      cp -a "$INPUT2" "$$TMP/revng-model-declarations.h";
      cp -a "$INPUT3" "$$TMP/revng-qemu-helpers-declarations.h";
      revng check-decompiled-c "$$TMP/decompiled.c" -I"$$TMP" -m32
  - type: revng-c.check-decompiled-c-arch-not-i386
    from:
      - type: revng-c.decompiled-c
        filter: one-per-architecture and !i386
      - type: revng-c.model-to-header
        filter: one-per-architecture and !i386
      - type: revng-c.helpers-to-header
        filter: one-per-architecture and !i386
    command: |-
      TMP=$$(temp -d);
      cp -a "$INPUT1" "$$TMP/decompiled.c";
      cp -a "$INPUT2" "$$TMP/revng-model-declarations.h";
      cp -a "$INPUT3" "$$TMP/revng-qemu-helpers-declarations.h";
      revng check-decompiled-c "$$TMP/decompiled.c" -I"$$TMP"
  - type: revng-c.test-segregate-stack-accesses
    from:
      - type: revng-qa.compiled-with-debug-info
        filter: for-segregate-stack-accesses
    command: |-
      RESUME=$$(temp -d);
      revng analyze --resume "$$RESUME" ImportBinary "$INPUT" -o /dev/null;
      revng analyze --resume "$$RESUME" AddPrimitiveTypes "$INPUT" -o /dev/null;

      revng model override-by-name
        "$$RESUME/context/model.yml"
        ${SOURCE}.override.yml
        > "$$RESUME/context/model-tmp.yml";
      mv "$$RESUME/context/model-tmp.yml" "$$RESUME/context/model.yml";

      revng analyze --resume "$$RESUME" DetectABI "$INPUT" -o /dev/null;
      revng analyze --resume "$$RESUME" detect-stack-size "$INPUT" -o /dev/null;
      revng artifact --resume "$$RESUME" MakeSegmentRefs "$INPUT" | FileCheck ${SOURCE}.filecheck.ll;
      revng artifact --resume "$$RESUME" DecompileToCInYAML "$INPUT" -o /dev/null
  - type: revng-c.test-detect-stack-size
    from:
      - type: revng-qa.compiled-with-debug-info
        filter: for-detect-stack-size
    command: |-
      RESUME=$$(temp -d);
      revng analyze --resume "$$RESUME" ImportBinary "$INPUT" -o /dev/null;
      revng analyze --resume "$$RESUME" AddPrimitiveTypes "$INPUT" -o /dev/null;
      revng analyze --resume "$$RESUME" DetectABI "$INPUT" -o /dev/null;
      revng analyze --resume "$$RESUME" detect-stack-size "$INPUT" | revng model compare "${SOURCE}.model.yml" -
